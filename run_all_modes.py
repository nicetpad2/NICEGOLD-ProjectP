#!/usr/bin/env python3
"""
ProjectP Production Mode Runner - ‡∏£‡∏±‡∏ô ProjectP ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö Production
‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: Default, Debug, Fast, Ultimate, Production + Safe Mode
"""

import subprocess
import sys
import os
import time
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, List

# Add src directory to Python path
src_path = Path(__file__).parent / "src"
if str(src_path) not in sys.path:
    sys.path.insert(0, str(src_path))

# Import core modules
try:
    from core.config import config_manager
    from core.resource_monitor import resource_monitor
    from core.display import banner_manager, progress_display
    from core.pipeline_modes import pipeline_manager
    HAS_CORE_MODULES = True
except ImportError as e:
    print(f"‚ùå Error importing core modules: {e}")
    HAS_CORE_MODULES = False


class AllModesRunner:
    """Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö"""
    
    def __init__(self):
        if HAS_CORE_MODULES:
            self.config = config_manager
            self.monitor = resource_monitor
            self.banner = banner_manager
            self.progress = progress_display
            self.pipeline = pipeline_manager
        self.results = {}
        self.start_time = time.time()
    
    def run_all_modes(self) -> Dict[str, Any]:
        """‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö"""
        
        if not HAS_CORE_MODULES:
            print("‚ùå Core modules not available. Cannot run all modes.")
            return {"error": "Core modules not available"}
        
        # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
        self.banner.print_professional_banner()
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
        self.banner.print_section_header("PRE-EXECUTION RESOURCE CHECK", "üîç")
        self.monitor.print_resource_summary()
        
        # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        modes_to_test = [
            ("preprocess", "‚öôÔ∏è Preprocessing Mode"),
            ("class_balance_fix", "üéØ Class Balance Fix Mode"),
            ("realistic_backtest", "üìà Realistic Backtest Mode"),
            ("robust_backtest", "üõ°Ô∏è Robust Backtest Mode"),
            ("realistic_backtest_live", "üìä Live Backtest Mode"),
            ("run_full_pipeline", "üöÄ Full Pipeline Mode"),
            ("debug_full_pipeline", "üîç Debug Pipeline Mode"),
            ("ultimate_pipeline", "üî• Ultimate Pipeline Mode")
        ]
        
        self.banner.print_section_header("STARTING ALL MODES TEST", "üöÄ")
        print(f"üìã Total modes to test: {len(modes_to_test)}")
        print(f"‚è∞ Test started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        # ‡∏£‡∏±‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î
        for i, (mode_key, mode_name) in enumerate(modes_to_test, 1):
            print(f"\n{'='*60}")
            print(f"üîÑ [{i}/{len(modes_to_test)}] Testing: {mode_name}")
            print(f"{'='*60}")
            
            # ‡∏ß‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤
            mode_start_time = time.time()
            
            try:
                # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î
                result = self.run_single_mode(mode_key)
                mode_duration = time.time() - mode_start_time
                
                # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                self.results[mode_key] = {
                    "name": mode_name,
                    "status": "success" if result else "warning",
                    "result": result,
                    "duration": mode_duration,
                    "timestamp": datetime.now().isoformat()
                }
                
                if result:
                    self.banner.print_success(f"‚úÖ {mode_name} completed successfully")
                    self.banner.print_info(f"üìä Result: {result}")
                else:
                    self.banner.print_warning(f"‚ö†Ô∏è {mode_name} completed with warnings")
                
                self.banner.print_info(f"‚è±Ô∏è Duration: {mode_duration:.2f} seconds")
                
            except Exception as e:
                mode_duration = time.time() - mode_start_time
                self.results[mode_key] = {
                    "name": mode_name,
                    "status": "error",
                    "result": None,
                    "error": str(e),
                    "duration": mode_duration,
                    "timestamp": datetime.now().isoformat()
                }
                
                self.banner.print_error(f"‚ùå {mode_name} failed: {e}")
                self.banner.print_info(f"‚è±Ô∏è Duration: {mode_duration:.2f} seconds")
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î
            if i < len(modes_to_test):  # ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                print(f"\nüßπ Optimizing memory before next mode...")
                self.monitor.optimize_memory()
                time.sleep(1)  # ‡∏û‡∏±‡∏Å‡∏™‡∏±‡πâ‡∏ô‡πÜ
        
        # ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        self.print_final_summary()
        
        return self.results
    
    def run_single_mode(self, mode_key: str) -> str:
        """‡∏£‡∏±‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"""
        
        mode_functions = {
            "preprocess": self.pipeline.run_preprocess_mode,
            "class_balance_fix": self.pipeline.run_class_balance_fix_mode,
            "realistic_backtest": self.pipeline.run_realistic_backtest_mode,
            "robust_backtest": self.pipeline.run_robust_backtest_mode,
            "realistic_backtest_live": self.pipeline.run_realistic_backtest_live_mode,
            "run_full_pipeline": self.pipeline.run_full_mode,
            "debug_full_pipeline": self.pipeline.run_debug_mode,
            "ultimate_pipeline": self.pipeline.run_ultimate_mode
        }
        
        if mode_key in mode_functions:
            return mode_functions[mode_key]()
        else:
            raise ValueError(f"Unknown mode: {mode_key}")
    
    def print_final_summary(self) -> None:
        """‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢"""
        
        total_duration = time.time() - self.start_time
        
        self.banner.print_section_header("üèÅ FINAL TEST SUMMARY", "üìä")
        
        # ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°
        total_modes = len(self.results)
        successful_modes = len([r for r in self.results.values() if r["status"] == "success"])
        warning_modes = len([r for r in self.results.values() if r["status"] == "warning"])
        failed_modes = len([r for r in self.results.values() if r["status"] == "error"])
        
        print(f"üìã Total modes tested: {total_modes}")
        self.banner.print_success(f"‚úÖ Successful: {successful_modes}")
        if warning_modes > 0:
            self.banner.print_warning(f"‚ö†Ô∏è With warnings: {warning_modes}")
        if failed_modes > 0:
            self.banner.print_error(f"‚ùå Failed: {failed_modes}")
        
        print(f"‚è±Ô∏è Total execution time: {total_duration:.2f} seconds")
        
        # ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î
        self.banner.print_section_header("üìã DETAILED RESULTS", "üìù")
        
        for mode_key, result in self.results.items():
            print(f"\nüî∏ {result['name']}:")
            
            if result['status'] == 'success':
                self.banner.print_success(f"   Status: {result['status'].upper()}")
            elif result['status'] == 'warning':
                self.banner.print_warning(f"   Status: {result['status'].upper()}")
            else:
                self.banner.print_error(f"   Status: {result['status'].upper()}")
            
            print(f"   Duration: {result['duration']:.2f}s")
            
            if result.get('result'):
                print(f"   Result: {result['result']}")
            
            if result.get('error'):
                print(f"   Error: {result['error']}")
        
        # ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        self.banner.print_section_header("üí° RECOMMENDATIONS", "üéØ")
        
        if failed_modes == 0:
            self.banner.print_success("üéâ All modes completed successfully!")
            self.banner.print_info("‚ú® Your refactored ProjectP structure is working perfectly!")
        elif failed_modes < total_modes / 2:
            self.banner.print_warning("‚ö†Ô∏è Some modes failed, but majority are working")
            self.banner.print_info("üîß Check failed modes and fix specific issues")
        else:
            self.banner.print_error("‚ùå Many modes failed")
            self.banner.print_info("üö® Review the refactored structure and dependencies")
        
        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        self.banner.print_section_header("üñ•Ô∏è FINAL RESOURCE STATUS", "üìä")
        self.monitor.print_resource_summary()
        
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        self.save_results()
    
    def save_results(self) -> None:
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå"""
        try:
            import json
            
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ï‡∏≤
            full_results = {
                "test_info": {
                    "timestamp": datetime.now().isoformat(),
                    "total_duration": time.time() - self.start_time,
                    "total_modes": len(self.results),
                    "python_version": sys.version,
                    "platform": sys.platform
                },
                "results": self.results
            }
            
            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô JSON
            output_file = f"all_modes_test_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(full_results, f, indent=2, ensure_ascii=False)
            
            self.banner.print_success(f"üìÑ Results saved to: {output_file}")
            
        except Exception as e:
            self.banner.print_warning(f"‚ö†Ô∏è Could not save results: {e}")

    def quick_test(self) -> None:
        """‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)"""
        
        if not HAS_CORE_MODULES:
            print("‚ùå Core modules not available. Cannot run quick test.")
            return
        
        self.banner.print_professional_banner()
        
        # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏Å
        quick_modes = [
            ("preprocess", "‚öôÔ∏è Preprocessing Mode"),
            ("run_full_pipeline", "üöÄ Full Pipeline Mode"),
            ("class_balance_fix", "üéØ Class Balance Fix Mode")
        ]
        
        self.banner.print_section_header("üöÄ QUICK TEST MODE", "‚ö°")
        print(f"üìã Testing {len(quick_modes)} essential modes")
        
        for mode_key, mode_name in quick_modes:
            print(f"\nüîÑ Testing: {mode_name}")
            
            try:
                start_time = time.time()
                result = self.run_single_mode(mode_key)
                duration = time.time() - start_time
                
                if result:
                    self.banner.print_success(f"‚úÖ {mode_name} - OK ({duration:.1f}s)")
                else:
                    self.banner.print_warning(f"‚ö†Ô∏è {mode_name} - Warning ({duration:.1f}s)")
                    
            except Exception as e:
                self.banner.print_error(f"‚ùå {mode_name} - Failed: {e}")
        
        self.banner.print_success("üéâ Quick test completed!")


def main():
    """Main function"""
    
    runner = AllModesRunner()
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö arguments
    if len(sys.argv) > 1:
        if sys.argv[1] == "--quick":
            runner.quick_test()
        elif sys.argv[1] == "--help":
            print(__doc__)
            print("\nUsage:")
            print("  python run_all_modes.py           # Run all modes")
            print("  python run_all_modes.py --quick   # Quick test (essential modes only)")
            print("  python run_all_modes.py --help    # Show this help")
        else:
            print("‚ùå Unknown argument. Use --help for usage information.")
    else:
        # ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î
        runner.run_all_modes()


if __name__ == "__main__":
    main()